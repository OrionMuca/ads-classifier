// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum PostStatus {
  ACTIVE
  SOLD
  HIDDEN
  DELETED
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String
  name         String?
  phone        String // Mandatory phone number
  avatar       String?
  role         Role     @default(USER)
  refreshToken String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  posts         Post[]
  savedPosts    SavedPost[]
  sentMessages  Message[]                 @relation("SentMessages")
  conversations ConversationParticipant[]
  profile       UserProfile?
}

model UserProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Social credentials for contact
  whatsapp  String? // WhatsApp number (can be same as phone)
  instagram String? // Instagram handle

  // Optional bio
  bio String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id          String     @id @default(uuid())
  name        String     @unique
  slug        String     @unique
  icon        String?
  description String?
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  posts Post[]

  @@index([parentId]) // For finding subcategories
}

model Location {
  id        String   @id @default(uuid())
  city      String
  state     String?
  country   String   @default("Albania")
  latitude  Float?
  longitude Float?
  weight    Int      @default(0) // Higher weight = more important city (for ordering)
  hasZones  Boolean  @default(false) // Whether this city has zones
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  zones Zone[]
  posts Post[]

  @@unique([city, country])
  @@index([weight])
}

model Zone {
  id         String   @id @default(uuid())
  name       String
  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  posts Post[]

  @@unique([name, locationId])
  @@index([locationId])
}

model Post {
  id          String     @id @default(uuid())
  title       String
  description String
  price       Decimal
  images      String[]
  status      PostStatus @default(ACTIVE)
  viewCount   Int        @default(0)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  zoneId String? // Optional zone for cities with zones
  zone   Zone?   @relation(fields: [zoneId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  savedBy SavedPost[]

  // Indexes for better query performance
  @@index([categoryId])
  @@index([locationId])
  @@index([userId])
  @@index([zoneId])
  @@index([status])
  @@index([status, createdAt]) // Common query: active posts ordered by date
  @@index([userId, status]) // User's posts by status
  @@index([createdAt]) // For sorting by creation date
}

model SavedPost {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([userId]) // For fetching user's saved posts
  @@index([postId]) // For checking if post is saved
}

model Conversation {
  id        String   @id @default(uuid())
  postId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants ConversationParticipant[]
  messages     Message[]

  @@index([postId]) // For finding conversations by post
  @@index([updatedAt]) // For sorting by most recent
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt       DateTime     @default(now())

  @@unique([conversationId, userId])
  @@index([conversationId]) // For finding participants in a conversation
  @@index([userId]) // For finding user's conversations
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation("SentMessages", fields: [senderId], references: [id])
  content        String
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())

  @@index([conversationId, createdAt]) // For fetching messages in order
  @@index([senderId]) // For finding messages by sender
  @@index([isRead]) // For unread message queries
}

enum AdLayout {
  CARD
  BANNER
}

model Ad {
  id         String   @id @default(uuid())
  title      String
  image      String // URL to ad image
  link       String? // Optional URL to redirect to when clicked
  position   Int      @default(0) // 0 = beginning, 5 = after 5 posts, 10 = after 10 posts, etc.
  layout     AdLayout @default(CARD) // CARD or BANNER layout
  active     Boolean  @default(true)
  clickCount Int      @default(0) // Track ad clicks
  viewCount  Int      @default(0) // Track ad views
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([active, position])
  @@index([layout])
}

model ThemeConfig {
  id       String  @id @default(uuid())
  name     String  @unique // e.g., "default", "dark-blue", "custom"
  isActive Boolean @default(false) // Only one active at a time

  // Primary Colors
  primary50  String @default("#eef2ff")
  primary100 String @default("#e0e7ff")
  primary200 String @default("#c7d2fe")
  primary300 String @default("#a5b4fc")
  primary400 String @default("#818cf8")
  primary500 String @default("#6366f1")
  primary600 String @default("#4f46e5")
  primary700 String @default("#4338ca")
  primary800 String @default("#3730a3")
  primary900 String @default("#312e81")

  // Secondary Colors
  secondary50  String @default("#ecfdf5")
  secondary100 String @default("#d1fae5")
  secondary200 String @default("#a7f3d0")
  secondary300 String @default("#6ee7b7")
  secondary400 String @default("#34d399")
  secondary500 String @default("#10b981")
  secondary600 String @default("#059669")
  secondary700 String @default("#047857")
  secondary800 String @default("#065f46")
  secondary900 String @default("#064e3b")

  // Accent Colors
  accent50  String @default("#fffbeb")
  accent100 String @default("#fef3c7")
  accent200 String @default("#fde68a")
  accent300 String @default("#fcd34d")
  accent400 String @default("#fbbf24")
  accent500 String @default("#f59e0b")
  accent600 String @default("#d97706")
  accent700 String @default("#b45309")
  accent800 String @default("#92400e")
  accent900 String @default("#78350f")

  // UI Colors
  background    String @default("#f8fafc")
  surface       String @default("#ffffff")
  textPrimary   String @default("#0f172a")
  textSecondary String @default("#64748b")

  // Branding
  logoUrl    String?
  faviconUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}
